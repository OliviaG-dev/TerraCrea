/**
 * EXEMPLES DE TESTS - Guide pratique
 *
 * Ce fichier montre les patterns les plus courants pour √©crire des tests
 * dans le projet TerraCr√©a. Utilisez ces exemples comme r√©f√©rence.
 *
 * ‚ö†Ô∏è Ce fichier n'est PAS ex√©cut√© dans la suite de tests (extension .example.ts)
 */

import { describe, it, expect, beforeEach, vi } from "vitest";

// === EXEMPLE 1: Test de service simple ===

/**
 * Test d'un service avec une seule m√©thode
 */
describe("EXEMPLE: Service simple", () => {
  // Configuration commune pour tous les tests de ce service
  beforeEach(() => {
    vi.clearAllMocks();
    // Setup des mocks communs
  });

  describe("getUserById", () => {
    it("should return user when user exists", async () => {
      // üîß ARRANGE - Pr√©parer les donn√©es et mocks
      const mockUser = {
        id: "user-123",
        email: "test@example.com",
        name: "John Doe",
      };

      // Mock de la r√©ponse Supabase
      const mockSupabase = {
        from: vi.fn().mockReturnValue({
          select: vi.fn().mockReturnValue({
            eq: vi.fn().mockReturnValue({
              single: vi.fn().mockResolvedValue({
                data: mockUser,
                error: null,
              }),
            }),
          }),
        }),
      };

      // üöÄ ACT - Ex√©cuter la m√©thode √† tester
      // const result = await UserService.getUserById('user-123');

      // ‚úÖ ASSERT - V√©rifier les r√©sultats
      // expect(result).toEqual(mockUser);
      // expect(mockSupabase.from).toHaveBeenCalledWith('users');
    });

    it("should return null when user does not exist", async () => {
      // Test du cas o√π l'utilisateur n'existe pas
      const mockSupabase = {
        from: vi.fn().mockReturnValue({
          select: vi.fn().mockReturnValue({
            eq: vi.fn().mockReturnValue({
              single: vi.fn().mockResolvedValue({
                data: null,
                error: { code: "PGRST116" }, // Code d'erreur Supabase pour "non trouv√©"
              }),
            }),
          }),
        }),
      };

      // const result = await UserService.getUserById('non-existent');
      // expect(result).toBeNull();
    });

    it("should handle database errors gracefully", async () => {
      // Test de gestion d'erreur
      const mockSupabase = {
        from: vi.fn().mockReturnValue({
          select: vi.fn().mockReturnValue({
            eq: vi
              .fn()
              .mockRejectedValue(new Error("Database connection failed")),
          }),
        }),
      };

      // Le service devrait g√©rer l'erreur gracieusement
      // const result = await UserService.getUserById('user-123');
      // expect(result).toBeNull(); // ou une valeur par d√©faut appropri√©e
    });
  });
});

// === EXEMPLE 2: Test avec authentification ===

/**
 * Test d'un service qui n√©cessite une authentification
 */
describe("EXEMPLE: Service avec authentification", () => {
  const mockUser = {
    id: "user-123",
    email: "test@example.com",
  };

  beforeEach(() => {
    vi.clearAllMocks();

    // Mock de l'utilisateur connect√© par d√©faut
    // supabaseMock.auth.getUser.mockResolvedValue({
    //   data: { user: mockUser },
    //   error: null,
    // });
  });

  describe("createUserProfile", () => {
    it("should create profile when user is authenticated", async () => {
      const profileData = {
        firstName: "John",
        lastName: "Doe",
        bio: "Test bio",
      };

      // Mock pour l'insertion
      // supabaseMock.from.mockReturnValue({
      //   insert: vi.fn().mockReturnValue({
      //     select: vi.fn().mockReturnValue({
      //       single: vi.fn().mockResolvedValue({
      //         data: { id: 'profile-123', ...profileData },
      //         error: null,
      //       }),
      //     }),
      //   }),
      // });

      // const result = await ProfileService.createUserProfile(profileData);
      // expect(result).toBeDefined();
      // expect(result.firstName).toBe('John');
    });

    it("should throw error when user is not authenticated", async () => {
      // Mock d'utilisateur non connect√©
      // supabaseMock.auth.getUser.mockResolvedValue({
      //   data: { user: null },
      //   error: null,
      // });
      // await expect(ProfileService.createUserProfile({})).rejects.toThrow(
      //   'Utilisateur non connect√©'
      // );
    });
  });
});

// === EXEMPLE 3: Test avec transformation de donn√©es ===

/**
 * Test d'un service qui transforme les donn√©es Supabase
 */
describe("EXEMPLE: Service avec transformation de donn√©es", () => {
  it("should transform Supabase data to app format", async () => {
    // Donn√©es brutes de Supabase (snake_case)
    const supabaseData = {
      id: "creation-123",
      title: "Test Creation",
      created_at: "2024-01-01T00:00:00Z",
      updated_at: "2024-01-01T00:00:00Z",
      artisan_id: "artisan-123",
      image_url: "https://example.com/image.jpg",
      is_available: true,
    };

    // Donn√©es attendues par l'app (camelCase)
    const expectedAppData = {
      id: "creation-123",
      title: "Test Creation",
      createdAt: "2024-01-01T00:00:00Z",
      updatedAt: "2024-01-01T00:00:00Z",
      artisanId: "artisan-123",
      imageUrl: "https://example.com/image.jpg",
      isAvailable: true,
    };

    // Mock avec les donn√©es Supabase
    // supabaseMock.from.mockReturnValue({
    //   select: vi.fn().mockReturnValue({
    //     eq: vi.fn().mockReturnValue({
    //       single: vi.fn().mockResolvedValue({
    //         data: supabaseData,
    //         error: null,
    //       }),
    //     }),
    //   }),
    // });

    // const result = await CreationsService.getCreation('creation-123');
    // expect(result).toEqual(expectedAppData);
  });
});

// === EXEMPLE 4: Test avec op√©rations CRUD ===

/**
 * Test complet des op√©rations CRUD
 */
describe("EXEMPLE: Tests CRUD complets", () => {
  const mockItem = {
    id: "item-123",
    title: "Test Item",
    description: "Test description",
  };

  describe("CREATE", () => {
    it("should create new item successfully", async () => {
      const newItemData = {
        title: "New Item",
        description: "New description",
      };

      // Mock pour l'insertion
      // supabaseMock.from.mockReturnValue({
      //   insert: vi.fn().mockReturnValue({
      //     select: vi.fn().mockReturnValue({
      //       single: vi.fn().mockResolvedValue({
      //         data: { id: 'new-item-123', ...newItemData },
      //         error: null,
      //       }),
      //     }),
      //   }),
      // });

      // const result = await ItemService.createItem(newItemData);
      // expect(result).toBeDefined();
      // expect(result.title).toBe('New Item');
    });
  });

  describe("READ", () => {
    it("should read item by id", async () => {
      // Mock pour la lecture
      // supabaseMock.from.mockReturnValue({
      //   select: vi.fn().mockReturnValue({
      //     eq: vi.fn().mockReturnValue({
      //       single: vi.fn().mockResolvedValue({
      //         data: mockItem,
      //         error: null,
      //       }),
      //     }),
      //   }),
      // });
      // const result = await ItemService.getItem('item-123');
      // expect(result).toEqual(mockItem);
    });

    it("should read all items", async () => {
      // Mock pour lister tous les √©l√©ments
      // supabaseMock.from.mockReturnValue({
      //   select: vi.fn().mockReturnValue({
      //     order: vi.fn().mockResolvedValue({
      //       data: [mockItem],
      //       error: null,
      //     }),
      //   }),
      // });
      // const result = await ItemService.getAllItems();
      // expect(result).toHaveLength(1);
      // expect(result[0]).toEqual(mockItem);
    });
  });

  describe("UPDATE", () => {
    it("should update item successfully", async () => {
      const updateData = { title: "Updated Title" };
      const updatedItem = { ...mockItem, ...updateData };

      // Mock pour la mise √† jour
      // supabaseMock.from.mockReturnValue({
      //   update: vi.fn().mockReturnValue({
      //     eq: vi.fn().mockReturnValue({
      //       select: vi.fn().mockReturnValue({
      //         single: vi.fn().mockResolvedValue({
      //           data: updatedItem,
      //           error: null,
      //         }),
      //       }),
      //     }),
      //   }),
      // });

      // const result = await ItemService.updateItem('item-123', updateData);
      // expect(result.title).toBe('Updated Title');
    });
  });

  describe("DELETE", () => {
    it("should delete item successfully", async () => {
      // Mock pour la suppression
      // supabaseMock.from.mockReturnValue({
      //   delete: vi.fn().mockReturnValue({
      //     eq: vi.fn().mockResolvedValue({
      //       error: null,
      //     }),
      //   }),
      // });
      // const result = await ItemService.deleteItem('item-123');
      // expect(result).toBe(true);
    });
  });
});

// === EXEMPLE 5: Test d'int√©gration ===

/**
 * Test d'int√©gration entre plusieurs services
 */
describe("EXEMPLE: Test d'int√©gration", () => {
  it("should complete full user workflow", async () => {
    // Workflow: Cr√©er utilisateur ‚Üí Cr√©er profil ‚Üí Cr√©er item
    // 1. Cr√©er utilisateur
    // supabaseMock.auth.signUp.mockResolvedValue({
    //   data: { user: { id: 'user-123', email: 'test@example.com' } },
    //   error: null,
    // });
    // const userResult = await AuthService.signUp({
    //   email: 'test@example.com',
    //   password: 'password123',
    // });
    // expect(userResult.data.user).toBeDefined();
    // 2. Cr√©er profil
    // supabaseMock.from.mockReturnValueOnce({
    //   insert: vi.fn().mockReturnValue({
    //     select: vi.fn().mockReturnValue({
    //       single: vi.fn().mockResolvedValue({
    //         data: { id: 'profile-123' },
    //         error: null,
    //       }),
    //     }),
    //   }),
    // });
    // const profileResult = await ProfileService.createProfile({
    //   firstName: 'John',
    //   lastName: 'Doe',
    // });
    // expect(profileResult).toBeDefined();
    // 3. Cr√©er item
    // supabaseMock.from.mockReturnValueOnce({
    //   insert: vi.fn().mockReturnValue({
    //     select: vi.fn().mockReturnValue({
    //       single: vi.fn().mockResolvedValue({
    //         data: { id: 'item-123', title: 'Test Item' },
    //         error: null,
    //       }),
    //     }),
    //   }),
    // });
    // const itemResult = await ItemService.createItem({
    //   title: 'Test Item',
    //   description: 'Test description',
    // });
    // expect(itemResult).toBeDefined();
    // V√©rifier que tout le workflow s'est bien pass√©
    // expect(userResult.data.user.id).toBe('user-123');
    // expect(profileResult.id).toBe('profile-123');
    // expect(itemResult.id).toBe('item-123');
  });
});

// === EXEMPLE 6: Helpers de test r√©utilisables ===

/**
 * Fonctions helper pour simplifier les tests
 */

// Helper pour cr√©er des mocks utilisateur
const createUserMock = (overrides = {}) => ({
  id: "user-123",
  email: "test@example.com",
  ...overrides,
});

// Helper pour setup l'authentification
const setupAuthMock = (user: any = null) => {
  // supabaseMock.auth.getUser.mockResolvedValue({
  //   data: { user },
  //   error: null,
  // });
};

// Helper pour setup une query simple
const setupSimpleQuery = (table: string, data: any, error = null) => {
  // supabaseMock.from.mockImplementation((tableName) => {
  //   if (tableName === table) {
  //     return {
  //       select: vi.fn().mockReturnValue({
  //         eq: vi.fn().mockReturnValue({
  //           single: vi.fn().mockResolvedValue({ data, error }),
  //         }),
  //       }),
  //     };
  //   }
  //   return createDefaultMock();
  // });
};

// Helper pour setup une mutation
const setupMutation = (table: string, result: any, error = null) => {
  // supabaseMock.from.mockImplementation((tableName) => {
  //   if (tableName === table) {
  //     return {
  //       insert: vi.fn().mockReturnValue({
  //         select: vi.fn().mockReturnValue({
  //           single: vi.fn().mockResolvedValue({ data: result, error }),
  //         }),
  //       }),
  //     };
  //   }
  //   return createDefaultMock();
  // });
};

// Exemple d'utilisation des helpers
describe("EXEMPLE: Utilisation des helpers", () => {
  it("should use helpers for cleaner tests", async () => {
    // Utilisation simple des helpers
    const mockUser = createUserMock({ name: "John Doe" });
    setupAuthMock(mockUser);
    setupSimpleQuery("users", mockUser);

    // Le test devient plus lisible
    // const result = await UserService.getCurrentUser();
    // expect(result).toEqual(mockUser);
  });
});

// === BONNES PRATIQUES ===

/**
 * üìù CONVENTIONS DE NOMMAGE
 *
 * Tests descriptifs:
 * ‚úÖ "should return user profile when user exists"
 * ‚úÖ "should throw error when user is not authenticated"
 * ‚ùå "should work"
 * ‚ùå "test user"
 *
 * Variables:
 * ‚úÖ mockUser, expectedResult, userData
 * ‚ùå data, result, stuff
 */

/**
 * üéØ STRUCTURE DES TESTS
 *
 * 1. Arrange - Pr√©parer les donn√©es et mocks
 * 2. Act - Ex√©cuter la m√©thode √† tester
 * 3. Assert - V√©rifier les r√©sultats
 *
 * Toujours dans cet ordre !
 */

/**
 * üîß MOCKS EFFICACES
 *
 * ‚úÖ Mocks sp√©cifiques au test
 * ‚úÖ Donn√©es minimales n√©cessaires
 * ‚úÖ Nettoyage entre les tests (beforeEach)
 * ‚ùå Mocks globaux trop complexes
 * ‚ùå Donn√©es compl√®tes inutiles
 */

/**
 * üö® GESTION D'ERREURS
 *
 * Toujours tester:
 * - Cas de succ√®s
 * - Cas d'erreur (base de donn√©es, r√©seau, etc.)
 * - Cas limites (donn√©es nulles, vides, invalides)
 * - Cas d'authentification (connect√©/d√©connect√©)
 */

/**
 * üìä ASSERTIONS
 *
 * ‚úÖ Assertions pr√©cises:
 * expect(result).toEqual(expectedData);
 * expect(result.status).toBe('success');
 * expect(mockFunction).toHaveBeenCalledWith(expectedArgs);
 *
 * ‚ùå Assertions vagues:
 * expect(result).toBeDefined();
 * expect(result).toBeTruthy();
 */

export {
  // Export des helpers pour r√©utilisation
  createUserMock,
  setupAuthMock,
  setupSimpleQuery,
  setupMutation,
};
