# Documentation des Tests - TerraCr√©a

## üìã Table des mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture des tests](#architecture-des-tests)
3. [Configuration et outils](#configuration-et-outils)
4. [Types de tests](#types-de-tests)
5. [Conventions de nommage](#conventions-de-nommage)
6. [Strat√©gie de mocking](#strat√©gie-de-mocking)
7. [Tests par service](#tests-par-service)
8. [Tests d'int√©gration](#tests-dint√©gration)
9. [Utilitaires de test](#utilitaires-de-test)
10. [Commandes utiles](#commandes-utiles)
11. [Bonnes pratiques](#bonnes-pratiques)
12. [D√©pannage](#d√©pannage)

## üìñ Vue d'ensemble

TerraCr√©a utilise une suite de tests compl√®te bas√©e sur **Vitest** pour assurer la qualit√© et la fiabilit√© du code. Les tests couvrent :

- **Services API** : Communication avec Supabase
- **Hooks React** : Logique m√©tier c√¥t√© client
- **Composants React** : Interface utilisateur
- **Utilitaires** : Fonctions helper
- **Int√©gration** : Flux de donn√©es entre services

### Statistiques des tests

```
üìä Couverture actuelle :
- Services: 147 tests ‚úÖ
- Int√©gration: 14 tests ‚úÖ
- Utils: 2 tests ‚úÖ
- Total: 163+ tests
```

## üèóÔ∏è Architecture des tests

```
src/
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îú‚îÄ‚îÄ components/          # Tests des composants React
‚îÇ   ‚îú‚îÄ‚îÄ context/             # Tests des contexts React
‚îÇ   ‚îú‚îÄ‚îÄ hooks/               # Tests des hooks personnalis√©s
‚îÇ   ‚îú‚îÄ‚îÄ integration/         # Tests d'int√©gration entre services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services-integration.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Tests unitaires des services
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authService.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ creationsApi.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favoritesApi.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ratingsApi.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reviewsApi.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ suggestionsService.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils/               # Tests des utilitaires
‚îÇ       ‚îî‚îÄ‚îÄ example.test.js
‚îú‚îÄ‚îÄ test-utils/              # Utilitaires et configuration
‚îÇ   ‚îú‚îÄ‚îÄ fixtures/            # Donn√©es de test
‚îÇ   ‚îú‚îÄ‚îÄ mocks/               # Mocks r√©utilisables
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ animatedHelperMock.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reactNativeMock.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabaseMock.ts
‚îÇ   ‚îú‚îÄ‚îÄ globalMocks.ts       # Mocks globaux
‚îÇ   ‚îú‚îÄ‚îÄ index.ts             # Point d'entr√©e
‚îÇ   ‚îî‚îÄ‚îÄ setup.ts             # Configuration Vitest
‚îî‚îÄ‚îÄ services/                # Code source des services
```

## ‚öôÔ∏è Configuration et outils

### Stack technologique

- **Framework de test** : [Vitest](https://vitest.dev/)
- **Mocking** : Vitest Mock Functions
- **Base de donn√©es** : Supabase (mock√©e)
- **React Native** : Mock complet pour l'environnement Node.js

### Configuration principale

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: "node",
    setupFiles: ["./src/test-utils/setup.ts"],
    globals: true,
  },
});
```

### Setup global

```typescript
// src/test-utils/setup.ts
import { vi } from "vitest";
import "./mocks/reactNativeMock";
import "./mocks/animatedHelperMock";

// Configuration des mocks globaux
beforeEach(() => {
  vi.clearAllMocks();
});
```

## üß™ Types de tests

### 1. Tests unitaires des services

**Objectif** : Tester chaque service de mani√®re isol√©e

```typescript
// Exemple : authService.test.ts
describe("AuthService", () => {
  describe("signUpWithEmailConfirmation", () => {
    it("should create user successfully", async () => {
      // Arrange
      const mockUser = { id: "user-123", email: "test@example.com" };
      supabaseMock.auth.signUp.mockResolvedValue({
        data: { user: mockUser },
        error: null,
      });

      // Act
      const result = await AuthService.signUpWithEmailConfirmation({
        email: "test@example.com",
        password: "password123",
        firstName: "John",
        lastName: "Doe",
      });

      // Assert
      expect(result.data.user).toEqual(mockUser);
      expect(result.needsConfirmation).toBe(true);
    });
  });
});
```

### 2. Tests d'int√©gration

**Objectif** : Tester les interactions entre plusieurs services

```typescript
// Exemple : services-integration.test.ts
describe("Data Flow Integration", () => {
  it("should test creation service individually", async () => {
    // Mock pour la cr√©ation
    (supabase.from as vi.Mock).mockImplementation(() => ({
      select: vi.fn().mockReturnValue({
        eq: vi.fn().mockReturnValue({
          single: vi.fn().mockResolvedValue({
            data: { id: "creation-123" },
            error: null,
          }),
        }),
      }),
      insert: vi.fn().mockReturnValue({
        select: vi.fn().mockReturnValue({
          single: vi.fn().mockResolvedValue({
            data: { id: "creation-123" },
            error: null,
          }),
        }),
        error: null,
      }),
    }));

    const result = await CreationsApi.createCreation({
      title: "Test Creation",
      description: "Test Description",
      price: 100,
      category: "jewelry",
      materials: ["test"],
      tags: ["test"],
      artisanId: "user-123",
    });

    expect(result).toBeDefined();
  });
});
```

### 3. Tests de composants

**Objectif** : Tester l'interface utilisateur React Native

```typescript
// Structure pour les futurs tests de composants
describe("CreationCard", () => {
  it("should render creation details correctly", () => {
    // Tests avec React Native Testing Library
  });
});
```

## üìù Conventions de nommage

### Fichiers de test

```
[NomDuFichier].test.[ts|js]
```

### Structure des tests

```typescript
describe('[NomDuService/Composant]', () => {
  describe('[nomDeLaMethode]', () => {
    it('should [comportement attendu] when [condition]', async () => {
      // Arrange - Pr√©paration
      // Act - Action
      // Assert - V√©rification
    });

    it('should handle [cas d'erreur] gracefully', async () => {
      // Test des cas d'erreur
    });
  });
});
```

### Nommage des mocks

```typescript
const mockUser = {
  /* donn√©es */
};
const mockCreation = {
  /* donn√©es */
};
const mockSupabaseCreation = {
  /* donn√©es brutes Supabase */
};
```

## üé≠ Strat√©gie de mocking

### Mock global de Supabase

```typescript
// src/test-utils/mocks/supabaseMock.ts
export const supabaseMock = {
  auth: {
    getUser: vi.fn(),
    signUp: vi.fn(),
    signInWithPassword: vi.fn(),
    // ... autres m√©thodes
  },
  from: vi.fn(),
  storage: { from: vi.fn() },
  rpc: vi.fn(),
};

// Configuration globale
vi.mock("../services/supabase", () => ({
  supabase: supabaseMock,
}));
```

### Patterns de mocking par service

#### 1. Mock simple pour les queries

```typescript
supabaseMock.from.mockReturnValue({
  select: vi.fn().mockReturnValue({
    eq: vi.fn().mockReturnValue({
      single: vi.fn().mockResolvedValue({
        data: mockData,
        error: null,
      }),
    }),
  }),
});
```

#### 2. Mock pour les mutations

```typescript
supabaseMock.from.mockReturnValue({
  insert: vi.fn().mockReturnValue({
    select: vi.fn().mockReturnValue({
      single: vi.fn().mockResolvedValue({
        data: { id: "new-id" },
        error: null,
      }),
    }),
    error: null,
  }),
});
```

#### 3. Mock pour les erreurs

```typescript
supabaseMock.from.mockReturnValue({
  select: vi.fn().mockReturnValue({
    eq: vi.fn().mockRejectedValue(new Error("Database error")),
  }),
});
```

## üîß Tests par service

### AuthService (30 tests)

**Fonctionnalit√©s test√©es :**

- Inscription avec confirmation email
- Connexion avec email/mot de passe
- D√©connexion
- Cr√©ation de profil artisan
- R√©initialisation de mot de passe
- Gestion des erreurs d'authentification

**Points cl√©s :**

- Mock de `supabase.auth`
- Validation des donn√©es utilisateur
- Gestion des erreurs r√©seau

### CreationsApi (18 tests)

**Fonctionnalit√©s test√©es :**

- CRUD des cr√©ations
- Recherche et filtrage
- Gestion des favoris
- Upload d'images
- Transformation des donn√©es Supabase

**Donn√©es de test :**

```typescript
const mockSupabaseCreation = {
  id: "creation-123",
  title: "Test Creation",
  description: "Test Description",
  price: 100,
  image_url: "https://example.com/image.jpg",
  category_id: "jewelry",
  artisan_id: "artisan-123",
  materials: ["test"],
  is_available: true,
  rating: 4.0,
  review_count: 5,
  created_at: "2024-01-01T00:00:00Z",
  updated_at: "2024-01-01T00:00:00Z",
  tags: ["test"],
  creation_tags: ["test"],
  category_label: "Bijoux",
  // Donn√©es artisan depuis la jointure
  artisan_name: "Test Artisan",
  artisan_location: "Paris",
  // ... autres champs artisan
};
```

### FavoritesApi (16 tests)

**Fonctionnalit√©s test√©es :**

- Ajout/suppression de favoris
- R√©cup√©ration des favoris utilisateur
- V√©rification du statut favori
- Toggle favori
- Comptage des favoris

### RatingsApi (17 tests)

**Fonctionnalit√©s test√©es :**

- Notation des cr√©ations
- R√©cup√©ration des notes utilisateur
- Calcul de moyenne
- Pr√©vention auto-notation
- Mise √† jour des notes

### ReviewsApi (22 tests)

**Fonctionnalit√©s test√©es :**

- Cr√©ation/modification d'avis
- R√©cup√©ration des avis par cr√©ation
- Suppression d'avis
- Pr√©vention auto-commentaire
- Gestion des noms d'utilisateur

### SuggestionsService (26 tests)

**Fonctionnalit√©s test√©es :**

- Suggestions de recherche
- Cache des suggestions
- Filtrage intelligent
- Gestion des erreurs r√©seau

## üîó Tests d'int√©gration

### Services Integration (14 tests)

**Sc√©narios test√©s :**

1. **Workflow utilisateur complet**

   - Inscription ‚Üí Profil artisan ‚Üí Cr√©ation

2. **Gestion d'erreurs**

   - Erreurs d'authentification
   - Erreurs de base de donn√©es

3. **Coh√©rence des donn√©es**

   - Synchronisation entre services
   - Op√©rations en cascade

4. **Performance**

   - Op√©rations concurrentes
   - Cache efficace

5. **S√©curit√©**

   - Permissions appropri√©es
   - Pr√©vention auto-actions

6. **Flux de donn√©es**
   - Test individuel par service
   - Validation des transformations

### Exemple de test d'int√©gration

```typescript
describe("Data Consistency Integration", () => {
  it("should maintain data consistency between related services", async () => {
    // Mock pour les cr√©ations (donn√©es Supabase brutes)
    const mockCreationsFrom = vi.fn().mockReturnValue({
      select: vi.fn().mockReturnValue({
        eq: vi.fn().mockReturnValue({
          single: vi.fn().mockResolvedValue({
            data: mockSupabaseCreation,
            error: null,
          }),
        }),
      }),
    });

    // Mock pour les notations
    const mockRatingsFrom = vi.fn().mockReturnValue({
      select: vi.fn().mockReturnValue({
        eq: vi.fn().mockReturnValue({
          eq: vi.fn().mockReturnValue({
            maybeSingle: vi.fn().mockResolvedValue({
              data: { rating: 4 },
              error: null,
            }),
          }),
        }),
      }),
    });

    (supabase.from as vi.Mock)
      .mockImplementationOnce(mockCreationsFrom)
      .mockImplementationOnce(mockRatingsFrom);

    // R√©cup√©rer une cr√©ation et sa notation
    const creationResult = await CreationsApi.getCreationById("creation-123");
    const ratingResult = await RatingsApi.getUserRating("creation-123");

    expect(creationResult).toEqual(mockCreation);
    expect(ratingResult).toBe(4);
  });
});
```

## üõ†Ô∏è Utilitaires de test

### Fixtures de donn√©es

```typescript
// src/test-utils/fixtures/
export const createMockUser = (overrides = {}) => ({
  id: "user-123",
  email: "test@example.com",
  ...overrides,
});

export const createMockCreation = (overrides = {}) => ({
  id: "creation-123",
  title: "Test Creation",
  description: "Test Description",
  price: 100,
  ...overrides,
});
```

### Helpers de test

```typescript
// src/test-utils/helpers.ts
export const mockSupabaseQuery = (data: any, error: any = null) => ({
  data,
  error,
});

export const mockSupabaseMethod = (returnValue: any) =>
  vi.fn().mockResolvedValue(returnValue);
```

## üöÄ Commandes utiles

### Ex√©cution des tests

```bash
# Tous les tests
npm test

# Tests sp√©cifiques
npm test -- src/__tests__/services/authService.test.ts

# Tests en mode watch
npm test -- --watch

# Tests avec couverture
npm test -- --coverage

# Tests d'un dossier
npm test -- src/__tests__/services/

# Tests avec pattern
npm test -- --grep "AuthService"
```

### Debug des tests

```bash
# Mode verbose
npm test -- --reporter=verbose

# Tests avec logs
npm test -- --reporter=verbose --no-silent

# Tests individuels en debug
npm test -- src/__tests__/services/authService.test.ts --reporter=verbose
```

## ‚úÖ Bonnes pratiques

### 1. Structure des tests

```typescript
describe("ServiceName", () => {
  // Configuration commune
  beforeEach(() => {
    vi.clearAllMocks();
    // Setup sp√©cifique
  });

  describe("methodName", () => {
    it("should handle success case", async () => {
      // Arrange
      const mockData = {
        /* test data */
      };
      setupMocks(mockData);

      // Act
      const result = await service.method(params);

      // Assert
      expect(result).toEqual(expectedResult);
      expect(mockFunction).toHaveBeenCalledWith(expectedParams);
    });

    it("should handle error case", async () => {
      // Test des cas d'erreur
      setupErrorMocks();

      await expect(service.method(params)).rejects.toThrow("Expected error");
    });
  });
});
```

### 2. Mocking efficace

```typescript
// ‚úÖ Bon : Mock sp√©cifique et r√©utilisable
const setupSuccessMock = (data: any) => {
  supabaseMock.from.mockReturnValue({
    select: vi.fn().mockReturnValue({
      eq: vi.fn().mockReturnValue({
        single: vi.fn().mockResolvedValue({ data, error: null }),
      }),
    }),
  });
};

// ‚ùå Mauvais : Mock trop verbeux et non r√©utilisable
supabaseMock.from.mockReturnValue({
  select: vi.fn().mockReturnValue({
    eq: vi.fn().mockReturnValue({
      single: vi.fn().mockResolvedValue({
        data: {
          /* donn√©es hardcod√©es */
        },
        error: null,
      }),
    }),
  }),
});
```

### 3. Tests lisibles

```typescript
// ‚úÖ Bon : Test descriptif et focalis√©
it("should return user profile when user exists and is authenticated", async () => {
  // Test sp√©cifique avec contexte clair
});

// ‚ùå Mauvais : Test trop vague
it("should work", async () => {
  // Test peu descriptif
});
```

### 4. Donn√©es de test

```typescript
// ‚úÖ Bon : Donn√©es minimales et pertinentes
const mockUser = {
  id: "user-123",
  email: "test@example.com",
};

// ‚ùå Mauvais : Donn√©es compl√®tes inutiles
const mockUser = {
  id: "user-123",
  email: "test@example.com",
  firstName: "John",
  lastName: "Doe",
  // ... 20 autres propri√©t√©s non utilis√©es
};
```

## üêõ D√©pannage

### Probl√®mes fr√©quents

#### 1. Mock non appliqu√©

**Sympt√¥me :** Tests qui √©chouent avec "Cannot read property of undefined"

**Solution :**

```typescript
// V√©rifier que le mock est bien configur√©
beforeEach(() => {
  vi.clearAllMocks();
  // Reconfigurer les mocks n√©cessaires
});
```

#### 2. Cha√Ænage de m√©thodes Supabase

**Sympt√¥me :** "mockReturnValue(...).eq is not a function"

**Solution :**

```typescript
// Structure compl√®te du mock
supabaseMock.from.mockReturnValue({
  select: vi.fn().mockReturnValue({
    eq: vi.fn().mockReturnValue({
      single: vi.fn().mockResolvedValue({ data, error: null }),
    }),
  }),
});
```

#### 3. Tests asynchrones

**Sympt√¥me :** Tests qui passent parfois et √©chouent parfois

**Solution :**

```typescript
// Toujours utiliser async/await
it("should handle async operation", async () => {
  const result = await service.asyncMethod();
  expect(result).toBeDefined();
});
```

#### 4. Donn√©es de transformation

**Sympt√¥me :** Tests qui √©chouent sur la transformation des donn√©es

**Solution :**

```typescript
// Utiliser les bonnes structures de donn√©es
const mockSupabaseData = {
  // Format snake_case de Supabase
  created_at: "2024-01-01T00:00:00Z",
  user_id: "user-123",
};

const expectedAppData = {
  // Format camelCase de l'app
  createdAt: "2024-01-01T00:00:00Z",
  userId: "user-123",
};
```

### Debug avanc√©

```typescript
// Ajouter des logs temporaires
it("should debug failing test", async () => {
  console.log("Mock calls:", supabaseMock.from.mock.calls);

  const result = await service.method();
  console.log("Result:", result);

  expect(result).toBeDefined();
});
```

## üìà M√©triques et √©volution

### Couverture actuelle

- **Services** : 95%+ de couverture
- **Int√©gration** : Sc√©narios principaux couverts
- **Cas d'erreur** : Gestion robuste des erreurs

### Prochaines √©tapes

1. **Tests de composants React Native**
2. **Tests E2E avec Detox**
3. **Tests de performance**
4. **Tests d'accessibilit√©**

### Contribution

Pour ajouter de nouveaux tests :

1. Suivre les conventions de nommage
2. Utiliser les mocks existants
3. Ajouter des cas d'erreur
4. Documenter les cas complexes
5. Maintenir la couverture √©lev√©e

---

üìö **Cette documentation est maintenue √† jour avec l'√©volution du projet. Pour toute question, consultez les tests existants ou contactez l'√©quipe.**
